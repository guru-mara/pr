<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel - Venue Management</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/2.2.19/tailwind.min.css" rel="stylesheet">
    <!-- Chart.js for analytics -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.7.1/chart.min.js"></script>
    <style>
        .section {
            display: none;
        }
        
        .section.active {
            display: block;
        }
        
        .menu-card {
            transition: transform 0.2s;
        }
        
        .menu-card:hover {
            transform: translateY(-5px);
        }

        .analytics-card {
            transition: all 0.3s ease;
        }
        
        .analytics-card:hover {
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }

        .chart-container {
            position: relative;
            height: 300px;
            width: 100%;
        }
    </style>
</head>
<body class="bg-gray-50">
    <script>
    (function() {
        const username = localStorage.getItem('username');
        const isAdmin = localStorage.getItem('isAdmin') === 'true';
        if (!username || !isAdmin) {
            console.log("Not an admin user, redirecting to auth page");
            window.location.href = 'auth.html';
        }
    })();
    </script>

    <div class="container mx-auto px-4 py-8 max-w-6xl">
        <div class="flex justify-between items-center mb-8">
            <h1 class="text-3xl font-bold text-gray-800">
                Venue Management Admin Panel
            </h1>
            <div>
                <button onclick="window.location.href='index.html'" class="bg-indigo-600 text-white px-4 py-2 rounded-md hover:bg-indigo-700 mr-2">
                    Main App
                </button>
                <button onclick="logout()" class="bg-red-600 text-white px-4 py-2 rounded-md hover:bg-red-700">
                    Logout
                </button>
            </div>
        </div>

        <div class="text-center text-gray-600 mb-8" id="welcomeMessage"></div>

        <!-- Main Menu Section -->
        <div id="menuSection" class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
            <div class="menu-card bg-white rounded-lg shadow-lg p-6 cursor-pointer" onclick="showSection('analyticsSection')">
                <h2 class="text-2xl font-semibold text-gray-800 mb-4">Analytics</h2>
                <p class="text-gray-600">View booking and venue statistics</p>
            </div>
            <div class="menu-card bg-white rounded-lg shadow-lg p-6 cursor-pointer" onclick="showSection('usersSection')">
                <h2 class="text-2xl font-semibold text-gray-800 mb-4">User Management</h2>
                <p class="text-gray-600">Manage system users</p>
            </div>
            <div class="menu-card bg-white rounded-lg shadow-lg p-6 cursor-pointer" onclick="showSection('bookingsSection')">
                <h2 class="text-2xl font-semibold text-gray-800 mb-4">Booking Management</h2>
                <p class="text-gray-600">View and manage all venue bookings</p>
            </div>
            <div class="menu-card bg-white rounded-lg shadow-lg p-6 cursor-pointer" onclick="showSection('venuesSection')">
                <h2 class="text-2xl font-semibold text-gray-800 mb-4">Venue Management</h2>
                <p class="text-gray-600">Add, edit, or remove venues</p>
            </div>
        </div>

        <!-- Analytics Section -->
        <div id="analyticsSection" class="section">
            <div class="bg-white rounded-lg shadow-lg p-6 mb-8">
                <h2 class="text-2xl font-semibold text-gray-800 mb-6">Analytics Dashboard</h2>
                
                <!-- Analytics Overview -->
                <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
                    <div class="analytics-card bg-white border border-gray-200 rounded-lg p-5 shadow">
                        <h3 class="text-lg font-medium text-gray-600 mb-3">Total Bookings</h3>
                        <p class="text-3xl font-bold text-indigo-600" id="totalBookings">0</p>
                        <p class="text-sm text-gray-500 mt-2">All time bookings</p>
                    </div>
                    <div class="analytics-card bg-white border border-gray-200 rounded-lg p-5 shadow">
                        <h3 class="text-lg font-medium text-gray-600 mb-3">Active Users</h3>
                        <p class="text-3xl font-bold text-green-600" id="activeUsers">0</p>
                        <p class="text-sm text-gray-500 mt-2">Registered users</p>
                    </div>
                    <div class="analytics-card bg-white border border-gray-200 rounded-lg p-5 shadow">
                        <h3 class="text-lg font-medium text-gray-600 mb-3">Venues Available</h3>
                        <p class="text-3xl font-bold text-amber-600" id="totalVenues">0</p>
                        <p class="text-sm text-gray-500 mt-2">Total venues managed</p>
                    </div>
                    <div class="analytics-card bg-white border border-gray-200 rounded-lg p-5 shadow">
                        <h3 class="text-lg font-medium text-gray-600 mb-3">Booking Rate</h3>
                        <p class="text-3xl font-bold text-purple-600" id="bookingRate">0%</p>
                        <p class="text-sm text-gray-500 mt-2">Current month utilization</p>
                    </div>
                </div>
                
                <!-- Charts Section -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
                    <!-- Bookings By Venue Chart -->
                    <div class="analytics-card bg-white border border-gray-200 rounded-lg p-5 shadow">
                        <h3 class="text-lg font-medium text-gray-600 mb-3">Bookings by Venue</h3>
                        <div class="chart-container">
                            <canvas id="venueBookingsChart"></canvas>
                        </div>
                    </div>
                    
                    <!-- Bookings By Day Chart -->
                    <div class="analytics-card bg-white border border-gray-200 rounded-lg p-5 shadow">
                        <h3 class="text-lg font-medium text-gray-600 mb-3">Bookings by Day of Week</h3>
                        <div class="chart-container">
                            <canvas id="bookingsByDayChart"></canvas>
                        </div>
                    </div>
                </div>
                
                <!-- Time Distribution and Department Charts -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <!-- Bookings by Time Chart -->
                    <div class="analytics-card bg-white border border-gray-200 rounded-lg p-5 shadow">
                        <h3 class="text-lg font-medium text-gray-600 mb-3">Bookings by Time of Day</h3>
                        <div class="chart-container">
                            <canvas id="bookingsByTimeChart"></canvas>
                        </div>
                    </div>
                    
                    <!-- Bookings by Department Chart -->
                    <div class="analytics-card bg-white border border-gray-200 rounded-lg p-5 shadow">
                        <h3 class="text-lg font-medium text-gray-600 mb-3">Bookings by Department</h3>
                        <div class="chart-container">
                            <canvas id="bookingsByDeptChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Users Section -->
        <div id="usersSection" class="section">
            <div class="bg-white rounded-lg shadow-lg p-6 mb-8">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-semibold text-gray-800">User Management</h2>
                    <button onclick="showModal('addUserModal')" class="bg-green-600 text-white px-4 py-2 rounded-md hover:bg-green-700">
                        Add New User
                    </button>
                </div>
                
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Name</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Email</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Role</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                                <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="users-list" class="bg-white divide-y divide-gray-200">
                            <!-- User rows will be populated here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Bookings Section -->
        <div id="bookingsSection" class="section">
            <div class="bg-white rounded-lg shadow-lg p-6 mb-8">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-semibold text-gray-800">Booking Management</h2>
                    <div class="flex items-center">
                        <input type="date" id="filter-date" class="form-input mr-2 rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500">
                        <button onclick="filterBookings()" class="bg-indigo-600 text-white px-4 py-2 rounded-md hover:bg-indigo-700">
                            Filter
                        </button>
                    </div>
                </div>
                
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Title</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Venue</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Date & Time</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Booked By</th>
                                <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="bookings-list" class="bg-white divide-y divide-gray-200">
                            <!-- Booking rows will be populated here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Venues Section -->
        <div id="venuesSection" class="section">
            <div class="bg-white rounded-lg shadow-lg p-6 mb-8">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-semibold text-gray-800">Venue Management</h2>
                    <button onclick="showModal('addVenueModal')" class="bg-green-600 text-white px-4 py-2 rounded-md hover:bg-green-700">
                        Add New Venue
                    </button>
                </div>
                
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Name</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Capacity</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Equipment</th>
                                <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="venues-list" class="bg-white divide-y divide-gray-200">
                            <!-- Venue rows will be populated here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Add User Modal -->
        <div id="addUserModal" class="fixed inset-0 bg-gray-600 bg-opacity-75 flex items-center justify-center hidden">
            <div class="bg-white rounded-lg p-6 max-w-md w-full">
                <h3 class="text-lg font-semibold text-gray-800 mb-4">Add New User</h3>
                <form id="addUserForm" class="space-y-4">
                    <div>
                        <label for="user-name" class="block text-sm font-medium text-gray-700 mb-1">Name</label>
                        <input type="text" id="user-name" class="form-input block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500" required>
                    </div>
                    <div>
                        <label for="user-email" class="block text-sm font-medium text-gray-700 mb-1">Email</label>
                        <input type="email" id="user-email" class="form-input block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500" required>
                    </div>
                    <div>
                        <label for="user-password" class="block text-sm font-medium text-gray-700 mb-1">Password</label>
                        <input type="password" id="user-password" class="form-input block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500" required>
                    </div>
                    <div>
                        <label for="user-role" class="block text-sm font-medium text-gray-700 mb-1">Role</label>
                        <select id="user-role" class="form-select block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500">
                            <option value="user">User</option>
                            <option value="admin">Admin</option>
                        </select>
                    </div>
                    <div class="flex justify-end space-x-3 pt-4">
                        <button type="button" onclick="hideModal('addUserModal')" class="bg-gray-200 text-gray-700 px-4 py-2 rounded-md hover:bg-gray-300">
                            Cancel
                        </button>
                        <button type="submit" class="bg-indigo-600 text-white px-4 py-2 rounded-md hover:bg-indigo-700">
                            Add User
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Add Venue Modal -->
        <div id="addVenueModal" class="fixed inset-0 bg-gray-600 bg-opacity-75 flex items-center justify-center hidden">
            <div class="bg-white rounded-lg p-6 max-w-md w-full">
                <h3 class="text-lg font-semibold text-gray-800 mb-4">Add New Venue</h3>
                <form id="addVenueForm" class="space-y-4">
                    <div>
                        <label for="venue-name" class="block text-sm font-medium text-gray-700 mb-1">Venue Name</label>
                        <input type="text" id="venue-name" class="form-input block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500" required>
                    </div>
                    <div>
                        <label for="venue-capacity" class="block text-sm font-medium text-gray-700 mb-1">Capacity</label>
                        <select id="venue-capacity" class="form-select block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500">
                            <option value="0-50">0-50</option>
                            <option value="50-100">50-100</option>
                            <option value="100-150">100-150</option>
                            <option value="150-200">150-200</option>
                            <option value="200+">200+</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Equipment</label>
                        <div class="flex flex-col space-y-2">
                            <label class="inline-flex items-center">
                                <input type="checkbox" id="venue-has-projector" class="form-checkbox h-4 w-4 text-indigo-600 focus:ring-indigo-500 border-gray-300 rounded">
                                <span class="ml-2 text-sm text-gray-700">Projector</span>
                            </label>
                            <label class="inline-flex items-center">
                                <input type="checkbox" id="venue-has-speaker" class="form-checkbox h-4 w-4 text-indigo-600 focus:ring-indigo-500 border-gray-300 rounded">
                                <span class="ml-2 text-sm text-gray-700">Speaker System</span>
                            </label>
                        </div>
                    </div>
                    <div class="flex justify-end space-x-3 pt-4">
                        <button type="button" onclick="hideModal('addVenueModal')" class="bg-gray-200 text-gray-700 px-4 py-2 rounded-md hover:bg-gray-300">
                            Cancel
                        </button>
                        <button type="submit" class="bg-indigo-600 text-white px-4 py-2 rounded-md hover:bg-indigo-700">
                            Add Venue
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script>
        // Store chart instances to destroy them before creating new ones
        let venueChart, dayChart, timeChart, departmentChart;
        
        document.addEventListener("DOMContentLoaded", () => {
            // Set welcome message
            const username = localStorage.getItem('username');
            document.getElementById('welcomeMessage').textContent = `Welcome, ${username} (Administrator)`;

            // Show the analytics section by default
            showSection('analyticsSection');
            
            // Initialize date filter with today's date
            const today = new Date();
            document.getElementById('filter-date').value = today.toISOString().split('T')[0];
            
            // Initialize data
            fetchUsers();
            fetchBookings();
            fetchVenues();
            
            // Add form event listeners
            document.getElementById('addUserForm').addEventListener('submit', function(e) {
                e.preventDefault();
                addUser();
            });
            
            document.getElementById('addVenueForm').addEventListener('submit', function(e) {
                e.preventDefault();
                addVenue();
            });
            
            // Initialize analytics
            initializeAnalytics();
        });
        
        function showSection(sectionId) {
            document.querySelectorAll('.section').forEach(section => {
                section.classList.remove('active');
            });
            document.getElementById(sectionId).classList.add('active');
        }
        
        function showModal(modalId) {
            document.getElementById(modalId).classList.remove('hidden');
        }
        
        function hideModal(modalId) {
            document.getElementById(modalId).classList.add('hidden');
        }
        
        function logout() {
            localStorage.removeItem('username');
            localStorage.removeItem('isAdmin');
            window.location.href = 'auth.html';
        }
        
        // Analytics functions that use only factual data
        function initializeAnalytics() {
            fetchAnalyticsData().then(data => {
                updateAnalyticsDashboard(data);
                createBookingsByVenueChart(data);
                createBookingsByDayChart(data);
                createBookingsByTimeChart(data);
                createBookingsByDepartmentChart(data);
            }).catch(error => {
                console.error("Error initializing analytics:", error);
            });
        }

        async function fetchAnalyticsData() {
            try {
                // Fetch all bookings - this will be our main data source
                const bookingsResponse = await fetch("http://localhost:3004/api/bookings");
                const bookings = await bookingsResponse.json();
                
                // Fetch users and venues for completeness
                const usersResponse = await fetch("http://localhost:3004/api/users");
                const users = await usersResponse.json();
                
                const venuesResponse = await fetch("http://localhost:3004/api/venues");
                const venues = await venuesResponse.json();
                
                // Process the data
                const processedData = processAnalyticsData(bookings, users, venues);
                
                return processedData;
            } catch (error) {
                console.error("Error fetching analytics data:", error);
                // Return empty data instead of sample data
                return {
                    totalBookings: 0,
                    totalUsers: 0,
                    totalVenues: 0,
                    bookingRate: 0,
                    bookingsByVenue: {},
                    bookingsByDayOfWeek: {
                        'Sunday': 0, 'Monday': 0, 'Tuesday': 0, 'Wednesday': 0, 
                        'Thursday': 0, 'Friday': 0, 'Saturday': 0
                    },
                    bookingsByTimeOfDay: {
                        'Morning (6-10)': 0,
                        'Late Morning (10-12)': 0,
                        'Afternoon (12-16)': 0,
                        'Evening (16-20)': 0
                    },
                    bookingsByDepartment: {
                        'Administration': 0,
                        'Faculty': 0,
                        'Student': 0,
                        'Clubs': 0,
                        'IT': 0,
                        'Other': 0
                    }
                };
            }
        }

        function processAnalyticsData(bookings, users, venues) {
            // Calculate actual metrics from real data
            const totalBookings = bookings.length;
            const totalUsers = users.length;
            const totalVenues = venues.length || 0;
            
            // Process bookings by venue
            const bookingsByVenue = {};
            
            // Process bookings by day of week
            const bookingsByDayOfWeek = {
                'Sunday': 0, 'Monday': 0, 'Tuesday': 0, 'Wednesday': 0, 
                'Thursday': 0, 'Friday': 0, 'Saturday': 0
            };
            
            // Process bookings by time of day
            const bookingsByTimeOfDay = {
                'Morning (6-10)': 0,
                'Late Morning (10-12)': 0,
                'Afternoon (12-16)': 0,
                'Evening (16-20)': 0
            };
            
            // Process bookings by department
            const bookingsByDepartment = {
                'Administration': 0,
                'Faculty': 0,
                'Student': 0,
                'Clubs': 0,
                'IT': 0,
                'Other': 0
            };
            
            // Calculate booking rate for the current month
            let bookingRate = 0;
            if (totalVenues > 0 && totalBookings > 0) {
                // Calculate days in the current month
                const now = new Date();
                const daysInMonth = new Date(now.getFullYear(), now.getMonth() + 1, 0).getDate();
                
                // Calculate the theoretical maximum bookings possible
                // Assuming each venue can be booked once per day, 8am-8pm slots (12 hours)
                const maxPossibleBookings = totalVenues * daysInMonth;
                
                // Calculate the actual booking rate
                // This is a simple calculation and could be refined based on your business rules
                bookingRate = Math.round((totalBookings / maxPossibleBookings) * 100);
                
                // Cap at 100% to ensure valid percentage
                bookingRate = Math.min(bookingRate, 100);
            }
            
            // Process each booking to collect detailed analytics
            bookings.forEach(booking => {
                // By Venue
                const venue = booking.venue || 'Unspecified';
                bookingsByVenue[venue] = (bookingsByVenue[venue] || 0) + 1;
                
                // By Day of Week
                let date;
                if (booking.date) {
                    // If booking has a specific date field
                    date = new Date(booking.date);
                } else if (booking.start) {
                    // If booking has a start datetime
                    date = new Date(booking.start);
                } else {
                    // Skip if no date information is available
                    return;
                }
                
                // Ensure date is valid
                if (!isNaN(date.getTime())) {
                    const dayOfWeek = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'][date.getDay()];
                    bookingsByDayOfWeek[dayOfWeek]++;
                    
                    // By Time of Day
                    let hour;
                    if (booking.time) {
                        // If there's a specific time field
                        const timeParts = booking.time.split(':');
                        hour = parseInt(timeParts[0]);
                    } else if (booking.start) {
                        // Extract time from start datetime
                        hour = new Date(booking.start).getHours();
                    } else {
                        // Skip if no time information
                        return;
                    }
                    
                    // Categorize by time slot
                    if (hour >= 6 && hour < 10) {
                        bookingsByTimeOfDay['Morning (6-10)']++;
                    } else if (hour >= 10 && hour < 12) {
                        bookingsByTimeOfDay['Late Morning (10-12)']++;
                    } else if (hour >= 12 && hour < 16) {
                        bookingsByTimeOfDay['Afternoon (12-16)']++;
                    } else if (hour >= 16 && hour <= 20) {
                        bookingsByTimeOfDay['Evening (16-20)']++;
                    }
                }
                
                // By Department
                const department = booking.department || 'Other';
                if (department in bookingsByDepartment) {
                    bookingsByDepartment[department]++;
                } else {
                    bookingsByDepartment['Other']++;
                }
            });
            
            return {
                totalBookings,
                totalUsers,
                totalVenues,
                bookingRate,
                bookingsByVenue,
                bookingsByDayOfWeek,
                bookingsByTimeOfDay,
                bookingsByDepartment
            };
        }
        
        function updateAnalyticsDashboard(data) {
            // Update metrics in the dashboard
            document.getElementById('totalBookings').textContent = data.totalBookings;
            document.getElementById('activeUsers').textContent = data.totalUsers;
            document.getElementById('totalVenues').textContent = data.totalVenues;
            document.getElementById('bookingRate').textContent = `${data.bookingRate}%`;
        }
        
        function createBookingsByVenueChart(data) {
            const canvas = document.getElementById('venueBookingsChart');
            const ctx = canvas.getContext('2d');
            
            // Destroy previous chart if it exists
            if (venueChart) {
                venueChart.destroy();
            }
            
            // Sort venues by number of bookings in descending order
            const sortedVenues = Object.entries(data.bookingsByVenue)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 8); // Display top 8 venues
            
            const labels = sortedVenues.map(item => item[0]);
            const values = sortedVenues.map(item => item[1]);
            
            venueChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Number of Bookings',
                        data: values,
                        backgroundColor: 'rgba(79, 70, 229, 0.8)',
                        borderColor: 'rgba(79, 70, 229, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                precision: 0
                            }
                        }
                    }
                }
            });
        }

        function createBookingsByDayChart(data) {
            const canvas = document.getElementById('bookingsByDayChart');
            const ctx = canvas.getContext('2d');
            
            // Destroy previous chart if it exists
            if (dayChart) {
                dayChart.destroy();
            }
            
            // Order days correctly from Monday to Sunday
            const orderedDays = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'];
            const values = orderedDays.map(day => data.bookingsByDayOfWeek[day]);
            
            dayChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: orderedDays,
                    datasets: [{
                        label: 'Number of Bookings',
                        data: values,
                        backgroundColor: 'rgba(16, 185, 129, 0.2)',
                        borderColor: 'rgba(16, 185, 129, 1)',
                        borderWidth: 2,
                        tension: 0.3,
                        fill: true,
                        pointBackgroundColor: 'rgba(16, 185, 129, 1)',
                        pointBorderColor: '#fff',
                        pointBorderWidth: 2,
                        pointRadius: 5
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                precision: 0
                            }
                        }
                    }
                }
            });
        }
        
        function createBookingsByTimeChart(data) {
            const canvas = document.getElementById('bookingsByTimeChart');
            const ctx = canvas.getContext('2d');
            
            // Destroy previous chart if it exists
            if (timeChart) {
                timeChart.destroy();
            }
            
            // Get time slots and their values
            const timeSlots = Object.keys(data.bookingsByTimeOfDay);
            const values = timeSlots.map(slot => data.bookingsByTimeOfDay[slot]);
            
            timeChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: timeSlots,
                    datasets: [{
                        label: 'Number of Bookings',
                        data: values,
                        backgroundColor: [
                            'rgba(245, 158, 11, 0.8)',
                            'rgba(217, 119, 6, 0.8)',
                            'rgba(180, 83, 9, 0.8)',
                            'rgba(146, 64, 14, 0.8)'
                        ],
                        borderColor: [
                            'rgba(245, 158, 11, 1)',
                            'rgba(217, 119, 6, 1)',
                            'rgba(180, 83, 9, 1)',
                            'rgba(146, 64, 14, 1)'
                        ],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                precision: 0
                            }
                        }
                    }
                }
            });
        }
        
        function createBookingsByDepartmentChart(data) {
            const canvas = document.getElementById('bookingsByDeptChart');
            const ctx = canvas.getContext('2d');
            
            // Destroy previous chart if it exists
            if (departmentChart) {
                departmentChart.destroy();
            }
            
            // Get department data
            const departments = Object.keys(data.bookingsByDepartment);
            const values = departments.map(dept => data.bookingsByDepartment[dept]);
            
            departmentChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: departments,
                    datasets: [{
                        data: values,
                        backgroundColor: [
                            'rgba(79, 70, 229, 0.8)',
                            'rgba(124, 58, 237, 0.8)',
                            'rgba(167, 139, 250, 0.8)',
                            'rgba(196, 181, 253, 0.8)',
                            'rgba(139, 92, 246, 0.8)',
                            'rgba(109, 40, 217, 0.8)'
                        ],
                        borderColor: [
                            'rgba(79, 70, 229, 1)',
                            'rgba(124, 58, 237, 1)',
                            'rgba(167, 139, 250, 1)',
                            'rgba(196, 181, 253, 1)',
                            'rgba(139, 92, 246, 1)',
                            'rgba(109, 40, 217, 1)'
                        ],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'right'
                        }
                    }
                }
            });
        }
        
        // Helper function to get venue capacity groups from server.js data
        function getVenueCapacityGroups() {
            return {
                "0-50": ["L1", "L2", "L3", "L4"],
                "50-100": ["BSR 100", "BSR 101", "BSR 102", "BSR 103"],
                "100-150": ["S200", "S201", "S202", "S203"],
                "150-200": ["S200", "S201", "S202", "S203"],
                "200+": ["Pavilion", "School Hall"]
            };
        }
        
        // Users Management
        function fetchUsers() {
            fetch("http://localhost:3004/api/users")
                .then(response => response.json())
                .then(users => {
                    const usersList = document.getElementById("users-list");
                    usersList.innerHTML = "";
                    
                    if (users.length === 0) {
                        usersList.innerHTML = `
                            <tr>
                                <td colspan="5" class="px-6 py-4 text-center text-gray-500">No users found</td>
                            </tr>`;
                        return;
                    }
                    
                    users.forEach(user => {
                        usersList.innerHTML += `
                            <tr>
                                <td class="px-6 py-4 whitespace-nowrap">${user.username || user.name}</td>
                                <td class="px-6 py-4 whitespace-nowrap">${user.email || user.username}</td>
                                <td class="px-6 py-4 whitespace-nowrap">${user.role || 'User'}</td>
                                <td class="px-6 py-4 whitespace-nowrap">
                                    <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full 
                                        bg-green-100 text-green-800">
                                        Active
                                    </span>
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                                    <button onclick="deleteUser('${user.username}')" class="text-red-600 hover:text-red-900">
                                        Delete
                                    </button>
                                </td>
                            </tr>`;
                    });
                })
                .catch(error => {
                    console.error('Error fetching users:', error);
                    alert('Failed to load users. Please try again later.');
                });
        }
        
        function addUser() {
            const name = document.getElementById('user-name').value;
            const email = document.getElementById('user-email').value;
            const password = document.getElementById('user-password').value;
            const isAdmin = document.getElementById('user-role').value === 'admin';
            
            // Use username as email if it's an email format
            const username = email.includes('@') ? email : name;
            
            fetch("http://localhost:3004/api/signup", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ username, password })
            })
            .then(response => {
                if (!response.ok) {
                    return response.json().then(err => { throw err; });
                }
                return response.json();
            })
            .then(() => {
                hideModal('addUserModal');
                document.getElementById('addUserForm').reset();
                fetchUsers();
                alert('User created successfully');
            })
            .catch(error => {
                console.error('Error creating user:', error);
                alert(error.message || 'Failed to create user. Please try again.');
            });
        }
        
        function deleteUser(username) {
            if (!confirm('Are you sure you want to delete this user? This action cannot be undone.')) {
                return;
            }
            
            // Don't allow deletion of admin account
            if (username === "admin@example.com") {
                alert("Cannot delete admin account");
                return;
            }
            
            fetch(`http://localhost:3004/api/users/${username}`, { 
                method: "DELETE" 
            })
            .then(response => {
                if (!response.ok) {
                    return response.json().then(err => { throw err; });
                }
                return response.json();
            })
            .then(() => {
                fetchUsers();
                alert('User deleted successfully');
            })
            .catch(error => {
                console.error('Error deleting user:', error);
                alert(error.message || 'Failed to delete user. Please try again.');
            });
        }
        
        // Bookings Management
        function fetchBookings() {
            fetch("http://localhost:3004/api/bookings")
                .then(response => response.json())
                .then(bookings => {
                    renderBookings(bookings);
                })
                .catch(error => {
                    console.error('Error fetching bookings:', error);
                    alert('Failed to load bookings. Please try again later.');
                });
        }
        
        function renderBookings(bookings) {
            const bookingsList = document.getElementById("bookings-list");
            bookingsList.innerHTML = "";
            
            if (bookings.length === 0) {
                bookingsList.innerHTML = `
                    <tr>
                        <td colspan="5" class="px-6 py-4 text-center text-gray-500">No bookings found</td>
                    </tr>`;
                return;
            }
            
            bookings.forEach(booking => {
                const start = booking.start || '';
                const parts = start.split('T');
                const datePart = parts[0] || '';
                const timePart = parts[1] || '';
                
                bookingsList.innerHTML += `
                    <tr>
                        <td class="px-6 py-4 whitespace-nowrap">${booking.title || 'Untitled'}</td>
                        <td class="px-6 py-4 whitespace-nowrap">${booking.venue || 'N/A'}</td>
                        <td class="px-6 py-4 whitespace-nowrap">${datePart} ${timePart}</td>
                        <td class="px-6 py-4 whitespace-nowrap">${booking.bookedBy || booking.username || 'Unknown'}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                            <button onclick="deleteBooking(${booking.id})" class="text-red-600 hover:text-red-900">
                                Delete
                            </button>
                        </td>
                    </tr>`;
            });
        }
        
        function filterBookings() {
            const filterDate = document.getElementById('filter-date').value;
            
            fetch(`http://localhost:3004/api/bookings?date=${filterDate}`)
                .then(response => response.json())
                .then(bookings => {
                    renderBookings(bookings);
                })
                .catch(error => {
                    console.error('Error filtering bookings:', error);
                    alert('Failed to filter bookings. Please try again.');
                });
        }
        
        function deleteBooking(bookingId) {
            if (!confirm('Are you sure you want to delete this booking? This action cannot be undone.')) {
                return;
            }
            
            // Use admin account for admin panel deletions
            // This bypasses the username check in the server.js route
            const username = 'admin@example.com';
            
            fetch(`http://localhost:3004/api/bookings/${bookingId}?username=${username}`, { 
                method: "DELETE" 
            })
            .then(response => {
                if (!response.ok) {
                    return response.json().then(err => { throw err; });
                }
                return response.json();
            })
            .then(data => {
                fetchBookings();
                alert(data.message || 'Booking deleted successfully');
                
                // Refresh analytics when a booking is deleted
                initializeAnalytics();
            })
            .catch(error => {
                console.error('Error deleting booking:', error);
                alert(error.message || 'Failed to delete booking. Please try again.');
            });
        }
        
        // Venues Management
        function fetchVenues() {
            fetch("http://localhost:3004/api/venues")
                .then(response => response.json())
                .then(venues => {
                    const venuesList = document.getElementById("venues-list");
                    venuesList.innerHTML = "";
                    
                    if (venues.length === 0) {
                        venuesList.innerHTML = `
                            <tr>
                                <td colspan="4" class="px-6 py-4 text-center text-gray-500">No venues found</td>
                            </tr>`;
                        return;
                    }
                    
                    venues.forEach(venue => {
                        const equipment = [];
                        if (venue.hasProjector) equipment.push('Projector');
                        if (venue.hasSpeaker) equipment.push('Speaker System');
                        
                        venuesList.innerHTML += `
                            <tr>
                                <td class="px-6 py-4 whitespace-nowrap">${venue.name}</td>
                                <td class="px-6 py-4 whitespace-nowrap">${venue.capacity || 'N/A'}</td>
                                <td class="px-6 py-4 whitespace-nowrap">${equipment.length ? equipment.join(', ') : 'None'}</td>
                                <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                                    <button onclick="deleteVenue(${venue.id})" class="text-red-600 hover:text-red-900">
                                        Delete
                                    </button>
                                </td>
                            </tr>`;
                    });
                })
                .catch(error => {
                    console.error('Error fetching venues:', error);
                    alert('Failed to load venues. Please try again later.');
                });
        }
        
        function addVenue() {
            const name = document.getElementById('venue-name').value;
            const capacity = document.getElementById('venue-capacity').value;
            const hasProjector = document.getElementById('venue-has-projector').checked;
            const hasSpeaker = document.getElementById('venue-has-speaker').checked;
            
            fetch("http://localhost:3004/api/venues", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ name, capacity, hasProjector, hasSpeaker })
            })
            .then(response => {
                if (!response.ok) {
                    return response.json().then(err => { throw err; });
                }
                return response.json();
            })
            .then(() => {
                hideModal('addVenueModal');
                document.getElementById('addVenueForm').reset();
                fetchVenues();
                
                // Refresh analytics when a venue is added
                initializeAnalytics();
                
                alert('Venue added successfully');
            })
            .catch(error => {
                console.error('Error creating venue:', error);
                alert(error.message || 'Failed to add venue. Please try again.');
            });
        }
        
        function deleteVenue(venueId) {
            if (!confirm('Are you sure you want to delete this venue? This action cannot be undone.')) {
                return;
            }
            
            fetch(`http://localhost:3004/api/venues/${venueId}`, { 
                method: "DELETE" 
            })
            .then(response => {
                if (!response.ok) {
                    return response.json().then(err => { throw err; });
                }
                return response.json();
            })
            .then(() => {
                fetchVenues();
                
                // Refresh analytics when a venue is deleted
                initializeAnalytics();
                
                alert('Venue deleted successfully');
            })
            .catch(error => {
                console.error('Error deleting venue:', error);
                alert(error.message || 'Failed to delete venue. Please try again.');
            });
        }
    </script>
</body>
</html>